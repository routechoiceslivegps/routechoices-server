/**
 * Leaflet.geojsonCSS
 *
 * @author Alexander Burtsev, http://burtsev.me, 2014
 * @author JosÃ© MarÃ­a MartÃ­nez, jmmluna@gmail.com, http://about.me/jmmluna, 2017
 * @license MIT
 */
(function (window, document, undefined) {
	if ( !window.L || !L.GeoJSON ) {
		return;
	}

	function getLayerMarkerStyle(style, latlng) {
		if ( style.icon ) {
			var smallIcon = new L.Icon({
				iconSize: style.icon.iconSize,
     			iconAnchor: style.icon.iconAnchor,
     			popupAnchor:  style.icon.popupAnchor,
				iconUrl:  style.icon.iconUrl,
				className: style.icon.className,
			});

			const classes = style.icon.className.split(" ");
			if (classes.includes("map-marker") || classes.includes("distance-marker")) {
				smallIcon = new L.Icon({
					iconSize: [24, 24],
					iconAnchor: [12, classes.includes("map-marker") ? 12 : 24],
					iconUrl: "data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\"/>",
					className: style.icon.className,
				});
			}

            if (classes.includes("leaflet-fa-marker")) {
                const innerIcon = document.createElement("i")
                innerIcon.className = classes.join(" ");
                innerIcon.style.color = 0

                const tmpTagEl = document.createElement("div");
                tmpTagEl.className = "leaflet-container"
                tmpTagEl.appendChild(innerIcon);

                const bodyEl = document.getElementsByTagName("body")[0];
                bodyEl.appendChild(tmpTagEl);
                const tmpTagSize = [
                    tmpTagEl.childNodes[0].offsetWidth,
                    tmpTagEl.childNodes[0].offsetHeight,
                ];

                bodyEl.removeChild(tmpTagEl);
                smallIcon = new L.DivIcon({
                    className: "",
                    html: innerIcon,
                    iconAnchor: [tmpTagSize[0] / 2, tmpTagSize[1] / 2],
                    iconSize: [tmpTagSize[0] , tmpTagSize[1]],
                });
            }

			return new L.Marker(latlng, {icon: smallIcon});
		}

		return new L.CircleMarker(latlng, style);
	}

	function setStyle(feature, style) {
		if (feature instanceof L.LayerGroup) {
			feature.eachLayer((f) => setStyle(f, style));
		} else if ( !(feature instanceof L.Marker) ) {
			feature.setStyle(style);
		}
	}

	L.GeoJSON.CSS = L.GeoJSON.extend({
		initialize: function (geojson, options) {

			var layerStyle = geojson.style;


			var styledOptions = L.extend({}, options, {

				 pointToLayer: function (feature, latlng) {
				 	var featureStyle = feature.style;
					var text = feature.properties.text

					let marker = null;
                    if ( featureStyle ) {
						marker = getLayerMarkerStyle(featureStyle, latlng);
		            } else if(layerStyle) {
		            	marker = getLayerMarkerStyle(layerStyle, latlng);
		        	} else {
		        		//default point layer
						marker = new L.Marker(latlng, {});
		        	}
					if (text) {
						const html = document.createElement('span')
						html.textContent = text;

						const tmpTagEl = document.createElement("div");
						tmpTagEl.className = "marker-text leaflet-container"
						tmpTagEl.appendChild(html);

						const bodyEl = document.getElementsByTagName("body")[0];
						bodyEl.appendChild(tmpTagEl);
						const tmpTagSize = [
							tmpTagEl.childNodes[0].offsetWidth +10,
							tmpTagEl.childNodes[0].offsetHeight +10,
						];
						html.style.color = featureStyle?.color || layerStyle?.color || "#000";
						const textIcon = new L.DivIcon({
							html,
							iconAnchor: [-15, 15],
							iconSize: tmpTagSize,
							className: "marker-text"
						})
						return new L.featureGroup([marker, new L.Marker(latlng, {icon: textIcon})])
					} else {
						return marker;
					}
		          },

				onEachFeature: function(json, feature) {
                    if(json.style) {
                    	setStyle(feature, json.style);
					}
					else if(layerStyle) {
						setStyle(feature, layerStyle);
					}
				}
			});


			L.setOptions(this, styledOptions);

			this._layers = {};

			if (geojson) {
				this.addData(geojson);
			}
		}
});


L.geoJson.css = function (geojson, options) {
	return new L.GeoJSON.CSS(geojson, options);
};
})(window, document);
